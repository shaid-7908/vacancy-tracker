<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Candidate List - SB Admin</title>
    <link href="css/styles.css" rel="stylesheet" />
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .table-hover tbody tr:hover {
        background-color: #f8f9fa;
      }

      .table td,
      .table th {
        vertical-align: middle;
      }

      #candidateBody td {
        white-space: nowrap;
      }
      #candidateBody td:nth-child(6) {
        white-space: normal; /* allow wrapping skills */
      }
    </style>
  </head>
  <body>
    <%- include('layouts/topnav')%>
    <div id="layoutSidenav">
      <%- include('layouts/sidebar') %>
      <div id="layoutSidenav_content">
        <main>
          <div class="container-fluid px-4">
            <div class="row mt-4">
              <div class="d-flex align-items-center gap-2 mb-3">
                <input
                  id="searchBox"
                  class="form-control"
                  style="max-width: 260px"
                  placeholder="Search name or skillsâ€¦"
                />
                <select
                  id="arrivalStatus"
                  class="form-select"
                  style="max-width: 180px"
                >
                  <option value="">Arrival: Any</option>
                  <option value="scheduled">scheduled</option>
                  <option value="arrived">arrived</option>
                  <option value="no-show">no-show</option>
                </select>
                <select
                  id="candidateStatus"
                  class="form-select"
                  style="max-width: 180px"
                >
                  <option value="">Candidate: Any</option>
                  <option value="new">new</option>
                  <option value="assigned">assigned</option>
                  <option value="hired">hired</option>
                  <option value="rejected">rejected</option>
                </select>
                <button id="clearFilters" class="btn btn-outline-secondary">
                  Clear
                </button>
                <a class="btn btn-primary">
                  +  Add Candidate
                </a>
              </div>
            </div>
            <div class="card mb-4">
              <div class="card-header">
                <i class="fas fa-table me-1"></i>
                DataTable Example
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table
                    id="candidateTable"
                    class="table table-bordered table-hover align-middle"
                  >
                    <thead class="table-dark">
                      <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Arrival Status</th>
                        <th>Scheduled Date</th>
                        <th>Skills</th>
                        <th style="width: 220px">Actions</th>
                      </tr>
                    </thead>

                    <tbody id="candidateBody">
                      <tr>
                        <td colspan="6" class="text-center text-muted">
                          Loading...
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </main>

        <footer class="py-4 bg-light mt-auto">
          <div class="container-fluid px-4">
            <div
              class="d-flex align-items-center justify-content-between small"
            >
              <div class="text-muted">Copyright &copy; Your Website 2023</div>
              <div>
                <a href="#">Privacy Policy</a>
                &middot;
                <a href="#">Terms &amp; Conditions</a>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="js/scripts.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="assets/demo/chart-area-demo.js"></script>
    <script src="assets/demo/chart-bar-demo.js"></script>

    <script>
      (function () {
        const $search = $("#searchBox");
        const $arrival = $("#arrivalStatus");
        const $status = $("#candidateStatus");
        const $clear = $("#clearFilters");
        const $tbody = $("#candidateBody");

        function toDateStr(d) {
          if (!d) return "";
          const dt = new Date(d);
          return isNaN(dt) ? "" : dt.toLocaleDateString();
        }

        function buildQuery() {
          const params = new URLSearchParams();
          if ($search.val().trim()) params.set("search", $search.val().trim());
          if ($arrival.val()) params.set("arrivalStatus", $arrival.val());
          if ($status.val()) params.set("candidateStatus", $status.val());
          return params.toString();
        }

        async function loadCandidates() {
          const qs = buildQuery();
          const url = "/candidate/filter" + (qs ? `?${qs}` : "");
          $tbody.html(
            '<tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>'
          );
          try {
            const res = await fetch(url, {
              headers: { Accept: "application/json" },
            });
            const json = await res.json();
            const rows = Array.isArray(json.data) ? json.data : json;

            if (!rows.length) {
              $tbody.html(
                '<tr><td colspan="6" class="text-center text-muted">No candidates found</td></tr>'
              );
              return;
            }

            $tbody.empty();
            rows.forEach((r) => {
              const fullName = [r.first_name, r.last_name]
                .filter(Boolean)
                .join(" ");
              const email = r.contact?.email || "";
              const phone = r.contact?.phone || "";
              const aStatus = r.arrival?.status || "";
              const aDate = toDateStr(r.arrival?.scheduledDate);
              const skills = (r.skillsDocs || [])
                .map((s) => s.name || s.skill_slug || "")
                .join(", ");

              $tbody.append(`
    <tr data-id="${r._id}">
      <td>${fullName}</td>
      <td>${email}</td>
      <td>${phone}</td>
      <td>${aStatus}</td>
      <td>${aDate}</td>
      <td>${skills}</td>
      <td>
        <div class="btn-group-gap" role="group">
          <a class="btn btn-warning" href="/candidate/${r._id}/edit">Edit</a>
          <button class="btn btn-outline-success assign-btn" 
                  data-id="${r._id}" 
                  data-name="${fullName}">
            Assign
          </button>
          <a class="btn btn-outline-danger">Delete</a>
        </div>
      </td>
    </tr>
  `);
            });
          } catch (e) {
            console.error("Failed to load candidates", e);
            $tbody.html(
              '<tr><td colspan="6" class="text-center text-danger">Error loading candidates</td></tr>'
            );
          }
        }

        // Debounce helper
        function debounce(fn, wait) {
          let t;
          return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), wait);
          };
        }

        $search.on("input", debounce(loadCandidates, 300));
        $arrival.on("change", loadCandidates);
        $status.on("change", loadCandidates);
        $clear.on("click", () => {
          $search.val("");
          $arrival.val("");
          $status.val("");
          loadCandidates();
        });

        loadCandidates();
      })();
    </script>
  </body>
</html>
